<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8"/>
        <script type="module">
            import Module from './build/Debug/12_monitor_dependencies.js';

            let v = 0;

            const moduleArgs = {
                arguments: ['monitor', 'dependencies'],
                monitorRunDependencies: left => console.log(`left ${left}`),
            };

            moduleArgs.preRun = [
                () => {
                    moduleArgs.addRunDependency('data1');

                    fetch('./data1.txt')
                        .then(response => response.arrayBuffer())
                        .then(buffer => {
                            console.log('write file1');
                            moduleArgs.FS.writeFile('/data1.txt', new Uint8Array(buffer));

                            moduleArgs.removeRunDependency('data1');
                        });
                },
                () => {
                    moduleArgs.addRunDependency('data2');

                    fetch('./data2.txt')
                        .then(response => response.arrayBuffer())
                        .then(buffer => {
                            console.log('write file2');
                            moduleArgs.FS.writeFile('/data2.txt', new Uint8Array(buffer));

                            moduleArgs.removeRunDependency('data2');
                        });
                },
            ];

            const modulePromise = Module(moduleArgs);

            await modulePromise.then(emsModule =>
            {
                v = emsModule._increment(v);
                console.log(`return=${v}`);
            });
        </script>
    </head>
    <body>
    </body>
</html>